<html>
<head>
    <!-- https://stackoverflow.com/questions/37824744/on-mobile-font-size-is-different-depending-on-the-number-of-paragraphs -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8" />

    <!--    <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tsparticles-confetti/2.12.0/tsparticles.confetti.bundle.min.js"></script>

    <style>
        body {
            color: white;
            background-color: black;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        a {
            color: white;
        }

        #loader {
            display: none;
        }
        body.loading #loader {
            display: block;
        }
        body.loading {
            justify-content: center;
        }
        body.loading #board1, body.loading #board2, body.loading #rules, #board1.hidden, #board2.hidden {
            visibility: hidden;
            height: 0px;
            overflow: hidden;
        }
        .boardWrapper {
            overflow: visible;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .board-cell {
            position: relative;
            border: 1px solid black;
            width: 25%;
            padding: 0px;
            margin: 0px;
        }
        @media (min-width:1024px) {
            .board-cell {
                width: 15%;
            }
        }
        .board-cell a {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            align-items: center;
            display: flex;
            justify-content: center;
            text-align: center;
        }
        .board-cell img.badge {
            width: 100%;
        }
        .board-cell img.lock {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20%;
        }
        .unhappy-cat-cell {
            border: 1px solid grey;
        }
        .achievement-cell img.badge {
            filter: gray;
            -webkit-filter: grayscale(1);
            filter: grayscale(1);
            opacity: 0.5;
        }
        .achievement-cell.active img.badge {
            filter: none;
            -webkit-filter: grayscale(0);
            filter: grayscale(0);
            opacity: 1;
        }
        .achievement-cell.active img.lock {
            display: none;
        }
        .achievement-cell.active a {
            display: none;
        }

        .unhappy-cat-cell img.badge {
            opacity: 0;
        }

        .unhappy-cat-cell.active {
            border: 1px solid #a00;
        }
        .unhappy-cat-cell.active img.badge {
            opacity: 1;
        }

        .unhappy-cat-cell a {
            display: none;
        }
        .unhappy-cat-cell.active a {
            display: flex;
            flex-direction: column;
            top: 0;
            justify-content: end;
            padding-bottom: 5px;
        }

        img {
            transition: left 1s ease, top 1s ease, width 1s ease, height 1s ease, opacity 1s ease;
        }

        .new_achievement {
            max-width: 100%;
        }
        .projectile {
            position: absolute;
            z-index: 100;
        }

        button.action-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            height: 5vh;
        }


        /* Overlay Background */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 1000;

            opacity: 0;
            transition: opacity 1s ease, transform 1s ease;
        }

        /* Popup Box */
        #popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            max-width: 90%;
            z-index: 1001;
            color: #000;
            opacity: 0;
            transition: opacity 1s ease, transform 1s ease;
        }

        /* Close Button */
        #close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        #overlay.show {
            display: block;
            opacity: 1;
        }

        #popup.show {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        #popup img {
            width: 50%;
            max-width: 196px;
        }
        #popup p:last-child {
            padding-bottom: 0px;
            margin-bottom: 0px;
        }
        .pct100 {
            opacity: 0.5;
        }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            height: 24px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background-color: #4caf50; /* Customize this color */
            width: 0%; /* Set initial width for progress */
            transition: width 0.3s ease;
            border-radius: 8px 0 0 8px; /* Optional rounded corners */
        }

        .progress-text {
            position: absolute;
            right: 10px; /* Position text on the right */
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #333; /* Text color */
        }

        .cell-progress {
            display: block;
            position: absolute;
            top: 0px;
            background-color: white;
            height: 2px;
            overflow: hidden;
            width: 50%;
        }
        .cell-progress.green {
            background-color: #4caf50;
        }
        .cell-progress.red {
            background-color: #f44336;
        }
        .cell-progress.yellow {
            background-color: #ffeb3b;
        }
        .active .cell-progress {
            display: none;
        }


    </style>

</head>
<body class="loading">
<div id="loader">
    <h1>Loading...</h1>
</div>
<div id="board1">
    <h1>Level 1: You've got a new achievement!</h1>
    <div style="display: table; margin: 0px auto;">
    <button class="action-btn" style="display: none">Return to game</button>
    </div>
    <p>
        <img src="../badge-images/t0_512.jpg" class="new_achievement projectile" />
        <img src="../badge-images/t0_512.jpg" class="new_achievement placeholder" />
    </p>
    <div class="boardWrapper">
        <p class="board-cell achievement-cell"><img src="../badge-images/t0_512.jpg" class="badge maybeTarget" />
            <img src="lock.png" width="32" class="lock" />
            <a href="javascript:openPopup()">How to unlock?</a>
            <span class="cell-progress" style="width: 100%"></span>
        </p>
        <p class="board-cell achievement-cell active"><img src="../badge-images/f0_512.jpg" class="badge maybeTarget" />
            <img src="lock.png" width="32" class="lock" />
            <a href="javascript:openPopup()">How to unlock3?</a>
            123
        </p>
        <p class="board-cell unhappy-cat-cell"><img src="../badge-images/c0_512.jpg" class="unhappy-cat badge maybeTarget" /><a href="javascript:openPopup()">How to kick me out?</a></p>
        <p class="board-cell unhappy-cat-cell active"><img src="../badge-images/c0_512.jpg" class="unhappy-cat badge maybeTarget" /><a href="javascript:openPopup()">How to kick me out?</a></p>
    </div>
</div>

<div id="board2" class="hidden">
    <div class="boardWrapper">
        board 2
    </div>
</div>

<div id="rules">
    <h1>Rules:</h1>
    <p>1. <img src="unlock.png" height="64" style="vertical-align: middle;" /> Unlock all locked items on the board above. Press locked cells to see how.</p>
    <p>2. <img src="no-grumpy-cats.jpg" width="64" style="vertical-align: middle;" /> Keep empty slots clear from grumpy cats. Kick them out as soon as they get in!</p>
</div>


<!-- Overlay -->
<div id="overlay" onclick="closePopup()"></div>

<!-- Popup Content -->
<div id="popup">

</div>

</body>
<script>

    document.getElementById('board2').innerHTML = document.getElementById('board1').innerHTML;

    function waitImagesLoadedPromise(images) {
        return new Promise(allDoneRes => {
            const imagesLoadedPromises = [...images].map(img => new Promise(imageLoadedRes => {
                if (img.complete) {
                    imageLoadedRes();
                    return;
                }
                img.onload = () => {
                    imageLoadedRes();
                };
                img.onerror = () => {
                    imageLoadedRes();
                };
            }));
            Promise.allSettled(imagesLoadedPromises).then(() => {
                allDoneRes();
            })
        });
    }

    // https://stackoverflow.com/a/26514148/1432640
    const Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}}


    class Board {
        constructor(boardElt) {
            this.boardElt = boardElt;
            this.boardEltWrapper = boardElt.querySelector('.boardWrapper');

            this.INACTIVE_BADGE_TEMPLATE_ELT = this.boardEltWrapper.getElementsByTagName('p')[0].outerHTML.replace("t0_512.jpg", "badge.jpg");
            this.ACTIVE_BADGE_TEMPLATE_ELT = this.boardEltWrapper.getElementsByTagName('p')[1].outerHTML.replace("f0_512.jpg", "badge.jpg");
            this.INACTIVE_UNHAPPY_CAT_TEMPLATE_ELT = this.boardEltWrapper.getElementsByTagName('p')[2].outerHTML.replace("c0_512.jpg", "badge.jpg");
            this.ACTIVE_UNHAPPY_CAT_TEMPLATE_ELT = this.boardEltWrapper.getElementsByTagName('p')[3].outerHTML.replace("c0_512.jpg", "badge.jpg");

            this.boardEltWrapper.innerHTML = '';
            this.hasTarget = false;

            this.projectileElt = boardElt.querySelector('.projectile');
            this.placeholderElt = boardElt.querySelector('.placeholder');
            this.projectileElt.classList.add('hidden');

            if (!Board.prototype.registry) {
                Board.prototype.registry = {};
            }
        }

        addCell(item, actionsToUnlock) {
            let itemHtml = "";
            if (item.active && item.badge === 'c0') {
                itemHtml = this.ACTIVE_UNHAPPY_CAT_TEMPLATE_ELT;
            } else if (item.active) {
                itemHtml = this.ACTIVE_BADGE_TEMPLATE_ELT;
            } else if (item.badge === 'c0') {
                itemHtml = this.INACTIVE_UNHAPPY_CAT_TEMPLATE_ELT;
            } else {
                itemHtml = this.INACTIVE_BADGE_TEMPLATE_ELT;
            }
            itemHtml = itemHtml.replace("badge.jpg", item.badge + "_512.jpg");
            if (item.target) {
                itemHtml = itemHtml.replace("maybeTarget", "target");
                let projectile = item.badge;
                if (item.projectileOverride) {
                    projectile = item.projectileOverride;
                }
                this.projectileElt.src = '../badge-images/' + projectile + '_512.jpg';
                this.placeholderElt.src = '../badge-images/' + projectile + '_512.jpg';
                this.hasTarget = true;
                this.projectileElt.classList.remove('hidden');
            }
            if (actionsToUnlock) {
                itemHtml = itemHtml.replace('openPopup()', 'openPopup(\'' + item.badge + '\', \'' + Base64.encode(JSON.stringify(actionsToUnlock)) + '\')');

                let pct = 0;
                for (let actionIdx = 0; actionIdx < actionsToUnlock.length; actionIdx++) {
                    const action = actionsToUnlock[actionIdx];
                    pct += action.progress_pct;
                }
                pct = Math.floor(pct / actionsToUnlock.length);
                itemHtml = itemHtml.replace('width: 100%', 'width: ' + pct + '%');
                if (pct < 33) {
                    itemHtml = itemHtml.replace('cell-progress', 'cell-progress red');
                } else if (pct < 66) {
                    itemHtml = itemHtml.replace('cell-progress', 'cell-progress yellow');
                } else {
                    itemHtml = itemHtml.replace('cell-progress', 'cell-progress green');
                }
            }
            this.boardEltWrapper.innerHTML += itemHtml;
        }

        waitTillReady() {
            return waitImagesLoadedPromise(this.boardElt.querySelectorAll('img')).then(() => {
                // Need for animation, otherwise it will just jump straight to size of the cell image
                this.projectileElt.style.width = this.projectileElt.width + "px";
                this.placeholderElt.style.width = this.placeholderElt.width + "px";
            });
        }

        move(onDone) {
            const boardCellImgWidth = this.boardElt.querySelector('.board-cell img').width;

            this.projectileElt.style.width = boardCellImgWidth + "px";
            this.placeholderElt.style.width = boardCellImgWidth + "px";

            this.placeholderElt.style.visibility = 'hidden';

            window.addEventListener('transitionend', () => {
                if (!this.hasTarget) {
                    setTimeout(() => {
                        this._showActionButton();
                        onDone();
                    }, 250);
                    return;
                }
                const targetElt = document.querySelector('.target');
                const targetRect = targetElt.getBoundingClientRect();
                const targetX = targetRect.left + window.scrollX;
                const targetY = targetRect.top + window.scrollY;

                const placeholderRect = this.placeholderElt.getBoundingClientRect();
                const placeholderX = placeholderRect.left + window.scrollX;
                const placeholderY = placeholderRect.top + window.scrollY;

                this.projectileElt.style.left = placeholderX + 'px';
                this.projectileElt.style.top = placeholderY + 'px';

                this.placeholderElt.style.width = '0px';

                setTimeout(() => {
                    this.projectileElt.style.left = targetX + "px";
                    this.projectileElt.style.top = (targetY - boardCellImgWidth) + "px";

                    window.addEventListener('transitionend', () => {
                        if (targetElt.parentElement.classList.contains('achievement-cell')) {
                            targetElt.style.transition = 'none';
                        }
                        targetElt.parentElement.classList.toggle('active');
                        this.projectileElt.style.display = 'none';
                        setTimeout(() => {
                            this._showActionButton();
                            onDone();
                        }, 250);
                    }, {once: true});
                }, 0);
            }, {once: true});
        }

        newBoardMode() {
            this.placeholderElt.style.display = 'none';
            this.projectileElt.style.display = 'none';
        }

        _showActionButton() {
            this.boardElt.querySelector('.action-btn').style.display = 'block';
        }
    }

    const requiredActions = {
        'c1': [
            {
                "remaining_time_secs": 3867,
                "challenge": "review_regularly_no_penalty",
                "badge": "c1",
                "progress_pct": 30
            }
        ],
        'c2': [
            {
                "remaining_time_secs": 3867,
                "challenge": "review_regularly_no_penalty",
                "badge": "c1",
                "progress_pct": 100
            },
            {
                "remaining_time_secs": 10000,
                "challenge": "review_regularly_no_prompt",
                "badge": "c2",
                "progress_pct": 10
            }
        ],
        'f0': [{
            "remaining_time_secs": 12345,
            "challenge": "update_formula",
            "badge": "f0",
            "progress_pct": 25
        }],
        't0': [
            {
                "remaining_time_secs": 1123,
                "challenge": "play_time",
                "badge": "t0",
                "progress_pct": 45
            }
        ],
        's0': [
            {
                "remaining_reviews": 3,
                "challenge": "review_regularly_no_penalty",
                "badge": "s0",
                "progress_pct":10
            }
        ],
        's1': [
            {
                "remaining_reviews": 3,
                "challenge": "review_regularly_no_penalty",
                "badge": "s1",
                "progress_pct":30
            }
        ],
        s2: [
            {
                "remaining_reviews": 6,
                "challenge": "review_regularly_no_penalty",
                "badge": "s2",
                "progress_pct":75
            }
        ]
    };

    function toTimeInterval(secs) {
        let hours = Math.floor(secs / 3600);
        let minutes = Math.floor((secs % 3600) / 60);
        return `${hours}h ${minutes}m`;
    }

    function renderProgressBar(pct) {
        return `<div class="progress-container">
            <div class="progress-bar" style="width: ${pct}%;"></div>
            <span class="progress-text">${pct}%</span>
        </div>`;
    }

    function renderReviewWithoutMisses(step, inactive, pct, timeSecs, withProgressBar)  {
        let stepPrefix = '';
        if (step) {
            stepPrefix = `${step}. `;
        }
        const ret = `<p class="pct${inactive ? 100 : 0}">${pct == 100 ? '✅ ' : ''} ${stepPrefix} Review <i>Formula</i> during next ${toTimeInterval(timeSecs)}
                    without misses 🚫🟥</p>`;
        if (withProgressBar) {
           return ret + renderProgressBar(pct);
        }
        return ret;
    }

    function renderReviewWithoutReminders(step, inactive, pct, timeSecs, withProgressBar)  {
        let stepPrefix = '';
        if (step) {
            stepPrefix = `${step}. `;
        }
        const ret = `<p class="pct${inactive ? 100 : 0}">${pct == 100 ? '✅ ' : ''} ${stepPrefix} Review <i>Formula</i> during next ${toTimeInterval(timeSecs)}
                    without reminders 🚫⏰</p>`;
        if (withProgressBar) {
           return ret + renderProgressBar(pct);
        }
        return ret;
    }

    function openPopup(badge, actionsBase64) {
        const actions = JSON.parse(Base64.decode(actionsBase64));
        let content = `<img src="../badge-images/${badge}_512.jpg" />`;
        if (badge === 'c0') {
            content += `<p>Earn any badge to kick it out!</p>`;
        } else if (badge === 'c1') {
            let action = actions[0];
            content += renderReviewWithoutMisses(null, action.progress_pct == 100, action.progress_pct, action.remaining_time_secs, true);
        } else if (badge === 'c2') {
            let action1 = actions[0];
            content += renderReviewWithoutMisses(1, action1.progress_pct == 100, action1.progress_pct, action1.remaining_time_secs, action1.progress_pct < 100);

            action2 = actions[1];
            content += renderReviewWithoutReminders(2, action1.progress_pct < 100, action2.progress_pct, action2.remaining_time_secs, action1.progress_pct == 100 && action2.progress_pct < 100);
        } else if (badge === 'f0') {
            let action = actions[0];
            content += `<p>Update the <i>Formula</i> after ${toTimeInterval(action.remaining_time_secs)} 🧪</p>`;
            content += renderProgressBar(action.progress_pct);
        } else if (badge === 't0') {
            let action = actions[0];
            content += `<p>Play the game during next ${toTimeInterval(action.remaining_time_secs)} 🎮</p>`;
            content += renderProgressBar(action.progress_pct);
        } else if (badge === 's0' || badge === 's1' || badge === 's2') {
            let action = actions[0];
            content += `<p>Review <i>Formula</i> ${action.remaining_reviews} more time(s) without misses 🚫🟥</p>`;
            content += renderProgressBar(action.progress_pct);
        }

        content += "<p><button class='action-btn' onclick='closePopup()'>Close</button></p>";

        document.getElementById('popup').innerHTML = content;

        document.getElementById('popup').classList.add('show');
        document.getElementById('overlay').classList.add('show');
    }

    function closePopup() {
        document.getElementById('popup').classList.remove('show');
        document.getElementById('overlay').classList.remove('show');
    }

    function fireConfetti() {
        console.log('fire start');
        const defaults = {
            spread: 360,
            ticks: 50,
            gravity: 5,
            decay: 1,
            startVelocity: 30,
            shapes: ["star"],
            colors: ["FFE400", "FFBD00", "E89400", "FFCA6C", "FDFFB8"],
        };

        function shoot() {
            confetti({
                ...defaults,
                particleCount: 40,
                scalar: 1.2,
                shapes: ["star"],
            });

            confetti({
                ...defaults,
                particleCount: 10,
                scalar: 0.75,
                shapes: ["circle"],
            });
        }

        setTimeout(shoot, 0);
        setTimeout(shoot, 100);
        setTimeout(shoot, 200);
        console.log('fire end');
    }


    const board1Items = [
        {
            badge: 'f0',
            active: true,
        },
        {
            badge: 's2',
        },
        {
            badge: 's1',
        },
        {
            badge: 's0',
        },
        {
            badge: 't0',

        },
        {
            badge: 'c0',
            active: true,
            projectileOverride: 't0',
        },
        {
            badge: 's0',
        },
        {
            badge: 's0',
            active: true,
        },
        {
            badge: 'c1'
        },
        {
            badge: 'c2',
        },
        {
            badge: 's1',
        },
        {
            badge: 's2',
        },
        {
            badge: 'c1',
            target: true,
        }
    ];

    const board2Items = [
        {
            badge: 'f0',
        },
        {
            badge: 's2',
        },
        {
            badge: 's1',
        },
        {
            badge: 's0',
        },
    ];


    const board = new Board(document.getElementById('board1'));
    board1Items.forEach(item => {
        board.addCell(item, requiredActions[item.badge]);
    });

    const board2 = new Board(document.getElementById('board2'));
    board2Items.forEach(item => {
        board2.addCell(item, requiredActions[item.badge].map(action => {
            action.progress_pct = 0;
            return action;
        }));
    });
    board2.newBoardMode();

    Promise.all([board.waitTillReady(), board2.waitTillReady()]).then(() => {

        document.body.classList.remove("loading");

        setTimeout(() => {

            fireConfetti();

            setTimeout(() => {
                board.move(() => {

                    document.getElementById('board1').classList.add('hidden');
                    document.getElementById('board2').classList.remove('hidden');

                });
            }, 1000);

        }, 250);
    });
</script>