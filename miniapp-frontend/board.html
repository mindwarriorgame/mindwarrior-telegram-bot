<html>
<head>
    <!-- https://stackoverflow.com/questions/37824744/on-mobile-font-size-is-different-depending-on-the-number-of-paragraphs -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--    <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tsparticles-confetti/2.12.0/tsparticles.confetti.bundle.min.js"></script>

    <style>
        body {
            color: white;
            background-color: black;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        a {
            color: white;
        }

        #loader {
            display: none;
        }
        body.loading #loader {
            display: block;
        }
        body.loading {
            justify-content: center;
        }
        body.loading #board1, body.loading #board2, body.loading #rules, #board1.hidden, #board2.hidden {
            visibility: hidden;
            height: 0px;
            overflow: hidden;
        }
        .boardWrapper {
            overflow: visible;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .board-cell {
            position: relative;
            border: 1px solid black;
            width: 25%;
            padding: 0px;
            margin: 0px;
        }
        @media (min-width:1024px) {
            .board-cell {
                width: 15%;
            }
        }
        .board-cell a {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            align-items: center;
            display: flex;
            justify-content: center;
            text-align: center;
        }
        .board-cell img.badge {
            width: 100%;
        }
        .board-cell img.lock {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20%;
        }
        .unhappy-cat-cell {
            border: 1px solid grey;
        }
        .achievement-cell img.badge {
            filter: gray;
            -webkit-filter: grayscale(1);
            filter: grayscale(1);
            opacity: 0.5;
        }
        .achievement-cell.active img.badge {
            filter: none;
            -webkit-filter: grayscale(0);
            filter: grayscale(0);
            opacity: 1;
        }
        .achievement-cell.active img.lock {
            display: none;
        }
        .achievement-cell.active a {
            display: none;
        }

        .unhappy-cat-cell img.badge {
            opacity: 0;
        }

        .unhappy-cat-cell.active {
            border: 1px solid #a00;
        }
        .unhappy-cat-cell.active img.badge {
            opacity: 1;
        }

        .unhappy-cat-cell a {
            display: none;
        }
        .unhappy-cat-cell.active a {
            display: flex;
            flex-direction: column;
            top: 0;
            justify-content: end;
            padding-bottom: 5px;
        }

        img {
            transition: left 1s ease, top 1s ease, width 1s ease, height 1s ease, opacity 1s ease;
        }

        .new_achievement {
            max-width: 100%;
        }
        .projectile {
            position: absolute;
            z-index: 100;
        }
    </style>

</head>
<body class="loading">
<div id="loader">
    <h1>Loading...</h1>
</div>
<div id="board1">
    <h1>Congratulations! You've got a new achievement!</h1>
    <p>
        <img src="../badge-images/time_512.jpg" class="new_achievement projectile" />
        <img src="../badge-images/time_512.jpg" class="new_achievement placeholder" />
    </p>
    <div class="boardWrapper">
        <p class="board-cell achievement-cell target"><img src="../badge-images/time_512.jpg" class="badge" />
            <img src="lock.png" width="32" class="lock" />
            <a href="javascript:alert(1)">How to unlock?</a></p>
        <p class="board-cell achievement-cell active"><img src="../badge-images/f0_512.jpg" class="badge" />
            <img src="lock.png" width="32" class="lock" />
            <a href="javascript:alert(1)">How to unlock?</a></p>
        <p class="board-cell unhappy-cat-cell"><img src="../badge-images/c0_512.jpg" class="unhappy-cat badge" /><a href="javascript:alert(1)">How to kick me out?</a></p>
        <p class="board-cell unhappy-cat-cell active"><img src="../badge-images/c0_512.jpg" class="unhappy-cat badge " /><a href="javascript:alert(1)">How to kick me out?</a></p>
    </div>
</div>

<div id="board2" class="hidden">
    <div class="boardWrapper">
        board 2
    </div>
</div>

<div id="rules">
    <h1>Rules:</h1>
    <p>1. <img src="unlock.png" height="64" style="vertical-align: middle;" /> Unlock all locked items on the board above. Press locked cells to see how.</p>
    <p>2. <img src="no-grumpy-cats.jpg" width="64" style="vertical-align: middle;" /> Keep empty slots clear from grumpy cats. Kick them out as soon as they get in!</p>
</div>
</body>
<script>
    function fireConfetti() {
        console.log('fire start');
        const defaults = {
            spread: 360,
            ticks: 50,
            gravity: 5,
            decay: 1,
            startVelocity: 30,
            shapes: ["star"],
            colors: ["FFE400", "FFBD00", "E89400", "FFCA6C", "FDFFB8"],
        };

        function shoot() {
            confetti({
                ...defaults,
                particleCount: 40,
                scalar: 1.2,
                shapes: ["star"],
            });

            confetti({
                ...defaults,
                particleCount: 10,
                scalar: 0.75,
                shapes: ["circle"],
            });
        }

        setTimeout(shoot, 0);
        setTimeout(shoot, 100);
        setTimeout(shoot, 200);
        console.log('fire end');
    }


    const board = [

        {
            badge: 'f0',
        },
        {
            badge: 'time',
            active: true,
        },
        {
            badge: 'c0',
            active: true,
            projectileOverride: 'time',
        },
        {
            badge: 's0',
        },
        {
            badge: 's0',
            active: true,
        },
        {
            badge: 'c1'
        },
        {
            badge: 's1',
        },
        {
            badge: 's2',
        },
        {
            badge: 'c1',
            target: true,
        }
    ];

    const boardElt = document.querySelector('#board1 .boardWrapper');
    const INACTIVE_BADGE_TEMPLATE_ELT = boardElt.getElementsByTagName('p')[0].outerHTML.replace("time_512.jpg", "badge.jpg");
    const ACTIVE_BADGE_TEMPLATE_ELT = boardElt.getElementsByTagName('p')[1].outerHTML.replace("f0_512.jpg", "badge.jpg");
    const INACTIVE_UNHAPPY_CAT_TEMPLATE_ELT = boardElt.getElementsByTagName('p')[2].outerHTML.replace("c0_512.jpg", "badge.jpg");
    const ACTIVE_UNHAPPY_CAT_TEMPLATE_ELT = boardElt.getElementsByTagName('p')[3].outerHTML.replace("c0_512.jpg", "badge.jpg");

    function buildBoard(board) {

        let boardHtml = "";
        let targetFound = false;
        for (let itemIdx = 0; itemIdx < board.length; itemIdx++) {
            const item = board[itemIdx];
            let itemHtml = "";
            if (item.active && item.badge === 'c0') {
                itemHtml = ACTIVE_UNHAPPY_CAT_TEMPLATE_ELT;
            } else if (item.active) {
                itemHtml = ACTIVE_BADGE_TEMPLATE_ELT;
            } else if (item.badge === 'c0') {
                itemHtml = INACTIVE_UNHAPPY_CAT_TEMPLATE_ELT;
            } else {
                itemHtml = INACTIVE_BADGE_TEMPLATE_ELT;
            }
            itemHtml = itemHtml.replace("badge.jpg", item.badge + "_512.jpg");
            if (item.target) {
                itemHtml = itemHtml.replace("<img ", "<img id='target' ");
                let projectile = item.badge;
                if (item.projectileOverride) {
                    projectile = item.projectileOverride;
                }
                document.querySelector('.projectile').src = '../badge-images/' + projectile + '_512.jpg';
                document.querySelector('.placeholder').src = '../badge-images/' + projectile + '_512.jpg';
                targetFound = true;
            }
            boardHtml += itemHtml;
        }

        if (!targetFound) {
            document.querySelector('.projectile').classList.add('hidden');
        }

        boardElt.innerHTML = boardHtml;
    }

    buildBoard(board);

    setTimeout(() => {
        const images = [...document.querySelectorAll("img")];

        function waitImagesLoadedPromise() {
            return new Promise(allDoneRes => {
                const imagesLoadedPromises = images.map(img => new Promise(imageLoadedRes => {
                    if (img.width > 0) {
                        imageLoadedRes();
                        return;
                    }
                    img.onload = () => {
                        imageLoadedRes();
                    };
                    img.onerror = () => {
                        imageLoadedRes();
                    };
                }));
                Promise.allSettled(imagesLoadedPromises).then(() => {
                    allDoneRes();
                })
            });
        }

        waitImagesLoadedPromise().then(() => {
            document.body.classList.remove("loading");
            document.querySelectorAll('.new_achievement').forEach(img => {
                img.style.width = img.width + "px";
            });

            setTimeout(() => {
                const boardCellImgWidth = document.querySelector('.board-cell img').width;
                document.querySelectorAll('.new_achievement').forEach(img => {
                    img.style.width = boardCellImgWidth + "px";
                });
                const placeholderElt = document.querySelector('.placeholder');
                placeholderElt.style.visibility = 'hidden';

                window.addEventListener('transitionend', () => {
                    const targetElt = document.getElementById('target');
                    if (!targetElt) {
                        fireConfetti();
                        return;
                    }
                    const targetRect = targetElt.getBoundingClientRect();
                    const targetX = targetRect.left + window.scrollX;
                    const targetY = targetRect.top + window.scrollY;

                    const placeholderRect = placeholderElt.getBoundingClientRect();
                    const placeholderX = placeholderRect.left + window.scrollX;
                    const placeholderY = placeholderRect.top + window.scrollY;

                    const projectileElt = document.querySelector('.projectile');
                    projectileElt.style.left = placeholderX + 'px';
                    projectileElt.style.top = placeholderY + 'px';

                    placeholderElt.style.width = '0px';

                    setTimeout(() => {
                        projectileElt.style.left = targetX + "px";
                        projectileElt.style.top = (targetY - boardCellImgWidth) + "px";

                        window.addEventListener('transitionend', () => {
                            if (targetElt.parentElement.classList.contains('achievement-cell')) {
                                targetElt.style.transition = 'none';
                            }
                            targetElt.parentElement.classList.toggle('active');
                            projectileElt.style.display = 'none';
                            fireConfetti();
                        }, {once: true});
                    }, 0);
                }, {once: true});

            }, 1000);
        });
    }, 0);
</script>