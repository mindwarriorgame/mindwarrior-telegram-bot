<html>
<head>
    <meta charset="UTF-8">
    <title>MindWarrior</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <script src="server-time.js"></script>

    <script>
        window.langs = {
            de: {
                applyChange: 'Änderung anwenden',
                startNewGame: 'Spiel starten',
                reward: 'Überprüfung abschließen',
                submittingData: 'Daten werden übermittelt...',
                error: 'Fehler',
                tryAgain: 'nochmals versuchen',

                sureDelete: "Sind Sie sicher, dass Sie alle Daten (einschließlich Ihrer Formel) löschen möchten?",
                sureDeleteDetails: 'Diese Aktion kann nicht rückgängig gemacht werden.',
                yesDelete: "Ja, alle meine Daten löschen",

                sureSetDifficulty: "Sind Sie sicher, dass Sie den Schwierigkeitsgrad des Spiels ändern möchten?",
                sureSetDifficultyDetail: "Dies setzt Ihren Fortschritt zurück und startet das Spiel von vorne.",
                yesSetDifficulty: "Ja, Schwierigkeitsgrad ändern",

                errBackend: 'Server antwortete mit ',
                errTelegram: 'Telegram antwortete mit ',

                formulaSafe: 'Ihre Formel bleibt privat.',
                formulaSafeExplained: 'Wir kopieren oder speichern Ihre Formel nicht auf unseren Servern. ' +
                    'Sie wird nur auf Ihrem Gerät gespeichert.',
                backToEditor: 'zurück zum Editor',
                placeholderNewGame: 'Schreiben Sie hier die "Formel der festen Entschlossenheit" und drücken Sie oben die Schaltfläche "Spiel starten"',
                placeholderChange: 'Schreiben Sie hier die "Formel der festen Entschlossenheit" und drücken Sie oben die Schaltfläche "Änderung anwenden"',
                share: 'Teilen Sie Ihre Formel mit anderen Spielern',
                shareExplained: 'Um die Formel zu teilen, folgen Sie bitte ' +
                    '<a href="https://github.com/mindwarriorgame/public-formulas/blob/main/README.md" target="_blank">diesen Anweisungen</a>' +
                    '<br /><br />' +
                    'Ihr shared_key_uuid lautet:',
                noFormulaTitle: 'Keine <i>Formel</i> wurde auf diesem Gerät gefunden!',
                noFormulaExplanation: 'Bitte schließen Sie dieses Fenster und verwenden Sie den Befehl "/formula", um Ihre <i>' +
                    '<a href="https://mindwarriorgame.org/faq.de#formula">Formel der festen Entschlossenheit</a></i> zu schreiben.' +
                    '<br /><br />' +
                    'Falls Sie auf einem anderen Gerät gespielt haben, kopieren Sie sie bitte manuell von dort. Das Spiel hat aufgrund ' +
                    '<a href="https://mindwarriorgame.org/privacy-policy.de">unserer strengen Datenschutzrichtlinie</a> keinen Zugriff darauf, ' +
                    'deshalb kann sie nicht automatisch synchronisiert werden.'

            },
            ru: {
                applyChange: 'Применить изменения',
                startNewGame: 'Начать игру',
                reward: 'Завершить просмотр',
                submittingData: 'Отправка данных...',
                error: 'Ошибка',
                tryAgain: 'попробовать снова',

                sureDelete: "Вы уверены, что хотите удалить все данные (включая свою Формулу)?",
                sureDeleteDetails: 'Это действие нельзя отменить.',
                yesDelete: "Да, безвозвратно удалить все мои данные",

                sureSetDifficulty: "Вы уверены, что хотите изменить сложность игры?",
                sureSetDifficultyDetail: "Это обнулит ваш прогресс и начнет игру сначала.",
                yesSetDifficulty: "Да, изменить сложность",

                errBackend: 'Сервер вернул ошибку ',
                errTelegram: 'Телеграм вернул ошибку ',

                formulaSafe: 'Ваша Формула остается конфиденциальной.',
                formulaSafeExplained: 'Мы не копируем и не храним вашу Формулу на наших серверах. ' +
                    'Она хранится только на вашем устройстве.',
                backToEditor: 'вернуться к редактору',
                placeholderNewGame: 'Напишите здесь свою "Формулу твердой решимости" и нажмите кнопку "Начать игру" (сверху)',
                placeholderChange: 'Напишите здесь свою "Формулу твердой решимости" и нажмите кнопку "Применить изменения" (сверху)',
                share: 'Поделитесь своей "Формулой" с другими игроками',
                shareExplained: 'Чтобы поделиться "Формулой", пожалуйста, следуйте ' +
                    '<a href="https://github.com/mindwarriorgame/public-formulas/blob/main/README.ru.md" target="_blank">этим инструкциям</a>' +
                    '<br /><br />' +
                    'Ваш shared_key_uuid: ',
                noFormulaTitle: '<i>Формула</i> не найдена!',
                noFormulaExplanation: 'Закройте это окно и воспользуйтесь командой "/formula" для ввода вашей <i>' +
                    '<a href="https://mindwarriorgame.org/faq.ru#formula">Формулы Твердой Решимости</a></i>.' +
                    '<br /><br />' +
                    'Если вы играли на другом устройстве, пожалуйста, скопируйте ее оттуда вручную. Игра не имеет до нее доступа ' +
                    'в силу <a href="https://mindwarriorgame.org/privacy-policy.ru">своей строгой политики конфиденциальности</a>, ' +
                    'поэтому мы не можем синхронизировать ее автоматически.'
            },
            en: {
                applyChange: 'Apply Change',
                startNewGame: 'Start Game',
                reward: 'Finish Review',
                submittingData: 'Submitting data...',
                error: 'Error',
                tryAgain: 'try again',

                sureDelete: "Are you sure you want to delete all the data (including your Formula)?",
                sureDeleteDetails: 'This action cannot be undone.',
                yesDelete: "Yes, erase all my data",

                sureSetDifficulty: "Are you sure you want to change the game difficulty?",
                sureSetDifficultyDetail: "This will reset your progress and start the game from the beginning.",
                yesSetDifficulty: "Yes, change the difficulty",

                errBackend: 'Server responded with ',
                errTelegram: 'Telegram responded with ',

                formulaSafe: 'Your Formula stays private.',
                formulaSafeExplained: 'We do not copy or store your Formula on our servers. ' +
                    'It is stored only on your device.',
                backToEditor: 'back to editor',
                placeholderNewGame: 'Write "Formula of firm resolution" here and press "Start Game" button above',
                placeholderChange: 'Write "Formula of firm resolution" here and press "Apply Change" button above',
                share: 'Share your Formula with other players',
                shareExplained: 'To share the Formula, please follow ' +
                    '<a href="https://github.com/mindwarriorgame/public-formulas/blob/main/README.md" target="_blank">these instructions</a>' +
                    '<br /><br />' +
                    'Your shared_key_uuid is:',
                noFormulaTitle: 'No <i>Formula</i> was found on this device!',
                noFormulaExplanation: 'Please close this window and use "/formula" command to write your <i>' +
                    '<a href="https://mindwarriorgame.org/faq.en#formula">Formula of Firm Resolution</a></i>.' +
                    '<br /><br />' +
                    'If you were playing on some other device, please copy it manually from there. The game does not have access to it due ' +
                    'to <a href="https://mindwarriorgame.org/privacy-policy.en">our strict privacy policy</a>, therefore it cannot be synchronised automatically.'
            },
            es: {
                applyChange: 'Aplicar Cambio',
                startNewGame: 'Iniciar Juego',
                reward: 'Finalizar la revisión',
                submittingData: 'Enviando datos...',
                error: 'Error',
                tryAgain: 'inténtalo de nuevo',

                sureDelete: "¿Estás seguro de que quieres borrar todos los datos (incluida tu Fórmula)?",
                sureDeleteDetails: 'Esta acción no se puede deshacer.',
                yesDelete: "Sí, borrar todos mis datos",

                sureSetDifficulty: "¿Estás seguro de que quieres cambiar la dificultad del juego?",
                sureSetDifficultyDetail: "Esto restablecerá tu progreso y comenzará el juego desde el principio.",
                yesSetDifficulty: "Sí, cambiar la dificultad",

                errBackend: 'El servidor respondió con ',
                errTelegram: 'Telegram respondió con ',

                formulaSafe: 'Tu Fórmula permanece privada.',
                formulaSafeExplained: 'No copiamos ni almacenamos tu Fórmula en nuestros servidores. ' +
                    'Solo se almacena en tu dispositivo.',
                backToEditor: 'volver al editor',
                placeholderNewGame: 'Escribe tu "Fórmula de firme resolución" aquí y presiona el botón "Iniciar Juego" arriba',
                placeholderChange: 'Escribe tu "Fórmula de firme resolución" aquí y presiona el botón "Aplicar Cambio" arriba',
                share: 'Comparte tu Fórmula con otros jugadores',
                shareExplained: 'Para compartir la Fórmula, sigue ' +
                    '<a href="https://github.com/mindwarriorgame/public-formulas/blob/main/README.md" target="_blank">estas instrucciones</a>' +
                    '<br /><br />' +
                    'Tu shared_key_uuid es:',
                noFormulaTitle: '¡No se encontró ninguna <i>Fórmula</i> en este dispositivo!',
                noFormulaExplanation: 'Por favor, cierre esta ventana y use el comando "/formula" para escribir su <i>' +
                    '<a href="https://mindwarriorgame.org/faq.es#formula">Fórmula de Resolución Firme</a></i>.' +
                    '<br /><br />' +
                    'Si estaba jugando en otro dispositivo, por favor cópiela manualmente desde allí. El juego no tiene acceso a ella ' +
                    'debido a <a href="https://mindwarriorgame.org/privacy-policy.es">nuestra estricta política de privacidad</a>, por lo tanto no puede sincronizarse automáticamente.'

            },
            fr: {
                applyChange: 'Appliquer le changement',
                startNewGame: 'Démarrer le jeu',
                reward: 'Terminer l\'examen',
                submittingData: 'Envoi des données...',
                error: 'Erreur',
                tryAgain: 'réessayer',

                sureDelete: "Êtes-vous sûr de vouloir supprimer toutes les données (y compris votre Formule) ?",
                sureDeleteDetails: 'Cette action est irréversible.',
                yesDelete: "Oui, effacer toutes mes données",

                sureSetDifficulty: "Êtes-vous sûr de vouloir changer la difficulté du jeu ?",
                sureSetDifficultyDetail: "Cela réinitialisera votre progression et recommencera le jeu depuis le début.",
                yesSetDifficulty: "Oui, changer la difficulté",

                errBackend: 'Le serveur a répondu avec ',
                errTelegram: 'Telegram a répondu avec ',

                formulaSafe: 'Votre Formule reste privée.',
                formulaSafeExplained: 'Nous ne copions ni ne stockons votre Formule sur nos serveurs. ' +
                    'Elle est stockée uniquement sur votre appareil.',
                backToEditor: 'retour à l\'éditeur',
                placeholderNewGame: 'Écrivez votre "Formule de ferme résolution" ici et appuyez sur le bouton "Démarrer le jeu" ci-dessus',
                placeholderChange: 'Écrivez votre "Formule de ferme résolution" ici et appuyez sur le bouton "Appliquer le changement" ci-dessus',
                share: 'Partagez votre Formule avec d\'autres joueurs',
                shareExplained: 'Pour partager la Formule, veuillez suivre ' +
                    '<a href="https://github.com/mindwarriorgame/public-formulas/blob/main/README.md" target="_blank">ces instructions</a>' +
                    '<br /><br />' +
                    'Votre shared_key_uuid est :',
                noFormulaTitle: 'Aucune <i>Formule</i> n\'a été trouvée sur cet appareil!',
                noFormulaExplanation: 'Veuillez fermer cette fenêtre et utiliser la commande "/formula" pour écrire votre <i>' +
                    '<a href="https://mindwarriorgame.org/faq.fr#formula">Formule de Résolution Ferme</a></i>.' +
                    '<br /><br />' +
                    'Si vous jouiez sur un autre appareil, veuillez la copier manuellement depuis cet appareil. Le jeu n\'y a pas accès en raison de ' +
                    '<a href="https://mindwarriorgame.org/privacy-policy.fr">notre politique de confidentialité stricte</a>, par conséquent, elle ne peut pas être synchronisée automatiquement.'
            }



        };

    </script>

    <meta
            name="description"
            content="MindWarrior"
    />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #222222;
            color: #ffffff;
            line-height: 1.6;
        }
        #root {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        textarea.active {
            background-color:#eeeeff;
        }

        #header, #footer {
            padding: 4px 0;
            display: flex;
            flex-direction: row;
            width: 100%;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        img {
            padding: 0 4px;
        }

        #content {
            width: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: scroll;
        }

        .hidden {
            display: none !important;
        }

        textarea {
            width: 100%;
            flex-grow: 1;
            padding: 10px;
            font-size: large;
            border: none;
            resize: none;
        }

        #review {
            background-color:#eeeeee;
            color: #000000;
            overflow-x: hidden;
            overflow-y: scroll;
            flex-grow: 1;
            min-width: 95%;
            padding: 5px;
            font-size: large;
            min-height:0;
        }
        #review a {
            color: #777777;
        }

        #text {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            text-align: center;
            padding: 0 10px;
        }

        #text button {
            background-color: darkred;
            padding: 8px;
            color: white;
        }

        #text .title {
            font-size: large;
        }
        #text .error {
            text-align: center;
        }
        pre {
            white-space: normal;
            word-break: break-word;
        }
        a {
            color: #777777;
            text-decoration: underline;
        }

        button.action-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            padding: 10px;
        }

        button.action-btn:hover {
            background-color: #218838;
        }

        button.action-btn:active {
            background-color: #1e7e34;
            transform: scale(0.98);
        }

        button.action-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.5);
        }

        button.action-btn:disabled {
            background-color: #8ba290;
            color: #6c757d;
            cursor: not-allowed;
        }

        button.blue-btn {
            background-color: #007bff;
        }

        button.blue-btn:hover {
            background-color: #0069d9;
        }

        button.blue-btn:active {
            background-color: #005cbf;
        }

        button.blue-btn:focus {
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5);
        }

        button.blue-btn:disabled {
            background-color: #b8daff;
        }

        #text input {
            width: 100%;
            padding: 10px;
            font-size: large;
            text-align: center;
            border: none;
            resize: none;
        }

    </style>
</head>
<body>

<div id="root">
    <div id="header">
        <img src="eye.png" height="32" />
        <img src="pencil.png" height="32" />
        <div style="flex-grow: 1">&nbsp;</div>
        <button class="action-btn">Apply Change</button>
        <div style="flex-grow: 1">&nbsp;</div>
        <img src="close.png" height="32" />
    </div>
    <div id="content">
        <textarea class="" autofocus="autofocus"></textarea>
        <div id="text" class="hidden">
            <div class="title">Submitting data...</div>
            <pre></pre>
            <pre></pre>
            <input type="text" /> <br />
            <a href="#">try again</a><br />
            <button>Yes, delete all data</button>
        </div>
        <div id="review" class="hidden"> asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd
            asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd
            asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd
            asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd
            asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd
            asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd
            asd asd asd asd asd asd asd asd asd asd asd asd asd a1sd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd
            asd asd asd asd asd asd asd asd asd asd asd asd asd asd asd
            asd asd asd asd asd asd asd asd asd asd asd asd asd asd a
        </div>
    </div>

    <div id="footer">
        <img src="lock.png" height="32" />
        <img src="share.png" height="32" />
        <div style="flex-grow: 1">&nbsp;</div>
    </div>
</div>
</body>

<script>


    const SERVER_TIME = new ServerTime();

    // https://github.com/adamvleggett/drawdown/blob/master/drawdown.js
    // Copy-pasting it because:
    //  1. It's small
    //  2. Don't want to over-complicate things with webpack
    //  3. Don't want to load it externally to speed up the page load
    //  4. To easily share in public-formulas generator (to preserve same algorithm)
    function markdown(n){var r=/\\([\\\|`*_{}\[\]()#+\-~])/g,t=/\n *&gt; *([^]*?)(?=(\n|$){2})/g,e=/\n( *)(?:[*\-+]|((\d+)|([a-z])|[A-Z])[.)]) +([^]*?)(?=(\n|$){2})/g,u=/(^|[^A-Za-z\d\\])(([*_])|(~)|(\^)|(--)|(\+\+)|`)(\2?)([^<]*?)\2\8(?!\2)(?=\W|_|$)/g,c=/^.*\n( *\|( *\:?-+\:?-+\:? *\|)* *\n|)/,f=/.*\n/g,l=/\||(.*?[^\\])\|/g;function o(r,t){n=n.replace(r,t)}function a(n,r){return"<"+n+">"+r+"</"+n+">"}function g(n){return n.replace(u,function(n,r,t,e,u,c,f,l,o,i){return r+a(e?o?"strong":"em":u?o?"s":"sub":c?"sup":f?"small":l?"big":"code",g(i))})}function i(n){return n.replace(r,"$1")}var p=[],s=0;return n="\n"+n+"\n",o(/</g,"&lt;"),o(/>/g,"&gt;"),o(/\t|\r|\uf8ff/g,"  "),n=function n(r){return r.replace(t,function(r,t){return a("blockquote",n(g(t.replace(/^ *&gt; */gm,""))))})}(n),o(/^([*\-=_] *){3,}$/gm,"<hr/>"),n=function n(r){return r.replace(e,function(r,t,e,u,c,f){var l=a("li",g(f.split(RegExp("\n ?"+t+"(?:(?:\\d+|[a-zA-Z])[.)]|[*\\-+]) +","g")).map(n).join("</li><li>")));return"\n"+(e?'<ol start="'+(u?e+'">':parseInt(e,36)-9+'" style="list-style-type:'+(c?"low":"upp")+'er-alpha">')+l+"</ol>":a("ul",l))})}(n),o(/<\/(ol|ul)>\n\n<\1>/g,""),o(/\n((```|~~~).*\n?([^]*?)\n?\2|((    .*?\n)+))/g,function(n,r,t,e,u){return p[--s]=a("pre",a("code",e||u.replace(/^    /gm,""))),s+""}),o(/((!?)\[(.*?)\]\((.*?)( ".*")?\)|\\([\\`*_{}\[\]()#+\-.!~]))/g,function(n,r,t,e,u,c,f){return p[--s]=u?t?'<img src="'+u+'" alt="'+e+'"/>':'<a href="'+u+'">'+i(g(e))+"</a>":f,s+""}),o(/\n(( *\|.*?\| *\n)+)/g,function(n,r){var t=r.match(c)[1];return"\n"+a("table",r.replace(f,function(n,r){return n==t?"":a("tr",n.replace(l,function(n,e,u){return u?a(t&&!r?"th":"td",i(g(e||""))):""}))}))}),o(/(?=^|>|\n)([>\s]*?)(#{1,6}) (.*?)( #*)? *(?=\n|$)/g,function(n,r,t,e){return r+a("h"+t.length,i(g(e)))}),o(/(?=^|>|\n)\s*\n+([^<]+?)\n+\s*(?=\n|<|$)/g,function(n,r){return a("p",i(g(r)))}),o(/-\d+\uf8ff/g,function(n){return p[parseInt(n)]}),n.trim()}

    function textToHtml(inputText) {
        return markdown(inputText);
    }
    const HEADER = {
        close: document.querySelector('#header img:last-child'),
        actionButton: document.querySelector('#header button'),
        pencil: document.querySelector('#header img:nth-child(2)'),
        eye: document.querySelector('#header img:first-child')
    };

    const CONTENT = {
        textarea: document.querySelector('#content textarea'),
        review: document.querySelector('#content #review'),
        text: {
            parent: document.querySelector('#content #text'),
            title: document.querySelector('#content #text .title'),
            preFirst: document.querySelectorAll('#content #text pre')[0],
            preSecond: document.querySelectorAll('#content #text pre')[1],
            link: document.querySelector('#content #text a'),
            button: document.querySelector('#content #text button'),
            input: document.querySelector('#content #text input')
        }
    };

    const FOOTER = {
        parent: document.querySelector('#footer'),
        lock: document.querySelector('#footer img:first-child'),
        share: document.querySelector('#footer img:nth-child(2)')
    };

    function hide(elt) {
        elt.classList.add('hidden');
    }

    function show(elt) {
        elt.classList.remove('hidden');
    }

    function hideEverything() {
        hide(HEADER.pencil);
        hide(HEADER.eye);
        hide(HEADER.actionButton);
        hide(HEADER.close);

        hide(FOOTER.parent);
        hide(FOOTER.lock);
        hide(FOOTER.share);

        hide(CONTENT.textarea);
        hide(CONTENT.review);

        hide(CONTENT.text.parent);
        hide(CONTENT.text.preSecond);
        hide(CONTENT.text.link);
        hide(CONTENT.text.button);
        hide(CONTENT.text.input);
    }


    class DataSubmitComponent {
        constructor(app, lang) {
            this.app = app;
            this.queryId = app.initDataUnsafe.query_id;
            this.data = null;
            this.lang = lang;
        }

        _showData(data) {
            hideEverything();

            show(CONTENT.text.parent);
            hide(CONTENT.text.preSecond);
            hide(CONTENT.text.link);

            CONTENT.text.title.innerHTML = this.lang.submittingData;
            CONTENT.text.link.innerHTML = this.lang.tryAgain;

            show(CONTENT.text.preFirst);
            CONTENT.text.preFirst.textContent = data;
        }

        _showError(error) {
            show(CONTENT.text.preSecond);
            show(CONTENT.text.link);
            CONTENT.text.preSecond.textContent = this.lang.error + ': ' + error;

            const tryAgainHandler = (e) => {
                e.preventDefault();
                hide(CONTENT.text.preSecond);
                hide(CONTENT.text.link);
                this.submitData(this.dataProvider);
                CONTENT.text.link.removeEventListener("click", tryAgainHandler);

                CONTENT.text.link.removeEventListener('click', tryAgainHandler);
            }

            CONTENT.text.link.addEventListener('click', tryAgainHandler);
        }

        async submitData(dataProvider) {
            const urlParams = new URLSearchParams(window.location.search);
            const langCode = urlParams.get('lang_code') || 'en';
            const env = urlParams.get('env') || "prod";

            this.dataProvider = dataProvider;
            const data = this.dataProvider();
            this._showData(data);
            const url = `https://boo.great-site.net?env=${env}&lang_code=${langCode}&query_id=` + encodeURIComponent(this.queryId) + '&data=' + encodeURIComponent(data)+'&_=' + new Date().getTime();
            const corsUrl = url; //'https://corsproxy.io/?' + encodeURIComponent(url);
            try {
                const response = await fetch(corsUrl, {mode: 'cors', signal: AbortSignal.timeout(15000)});
                if (!response.ok) {
                    this._showError(this.lang.errBackend + `${response.status} ${response.statusText}`);
                    return;
                }
                const json = await response.json();
                if (json.status < 200 || json.status > 299) {
                    this._showError(this.lang.errTelegram + `${json.status} ${json.response}`);
                    return;
                }
                this.app.close();
            } catch (err) {
                this._showError(err.message);
            }

        }
    }

    class DeleteDataComponent {
        constructor(dataSubmitter, lang) {
            hideEverything();

            show(CONTENT.text.parent);
            CONTENT.text.title.innerHTML = lang.sureDelete;
            CONTENT.text.preFirst.innerHTML = lang.sureDeleteDetails;
            show(CONTENT.text.button);
            CONTENT.text.button.textContent = lang.yesDelete;
            CONTENT.text.button.addEventListener("click", (e) => {
                e.preventDefault();
                window.localStorage.clear();

                dataSubmitter.submitData(() => "delete_data_confirmed");
            });
        }
    }

    class ViewLocalstorageDataComponent {
        constructor() {
            hideEverything();

            show(CONTENT.text.parent);
            CONTENT.text.parent.innerHTML = JSON.stringify(window.localStorage, null, 2).replace(/\n( *)/g, function (match, p1) {
                return '<br>' + '&nbsp;'.repeat(p1.length);
            });
            CONTENT.text.parent.style['text-align'] = "left";
        }
    }

    class NextReviewDataProvider {
        constructor(nextReviewPromptMinutes) {
            this.nextReviewPromptMinutes = nextReviewPromptMinutes;
        }

        calculateNextReviewsData() {
            const splitOffsets = this.nextReviewPromptMinutes.split(',');
            console.log("Client time", Date.now());
            console.log("Server time", SERVER_TIME.now());
            const nextReviewTimes = splitOffsets.map(offset => {
                const offsetInt = parseInt(offset);
                const nextReviewAt = new Date(SERVER_TIME.now() + offsetInt * 60 * 1000);
                return nextReviewAt.toLocaleTimeString(undefined, { hour: 'numeric', minute: 'numeric' });
            });

            return "next_review:" + nextReviewTimes.join(',,');
        }

    }

    class ReviewComponent {
        constructor(dataSubmitter, lang, nextReviewPromptMinutes) {

            this.dataSubmitter = dataSubmitter;

            this.nextReviewsDataProvider = new NextReviewDataProvider(nextReviewPromptMinutes);

            hideEverything();

            show(CONTENT.review);
            CONTENT.review.innerHTML = textToHtml(window.localStorage.getItem("formula") || '');

            show(HEADER.actionButton);

            HEADER.actionButton.addEventListener("click", (e) => {
                e.preventDefault();

                this.dataSubmitter.submitData(() => {

                    return "reviewed_at:__timestamp__;" + this.nextReviewsDataProvider.calculateNextReviewsData();
                });
            });

            let reviewCountdown = 10;
            function refreshReviewButton() {
                reviewCountdown--;
                if (reviewCountdown > 0) {
                    HEADER.actionButton.innerHTML = lang.reward + " <span style='color: white'>(" + reviewCountdown + ")</span>";
                    HEADER.actionButton.setAttribute('disabled', 'disabled');
                }
                if (reviewCountdown === 0) {
                    HEADER.actionButton.innerHTML = lang.reward;
                    HEADER.actionButton.removeAttribute('disabled');
                }
            }
            setInterval(() => {
                refreshReviewButton()
            }, 1000);
            refreshReviewButton();
        }
    }

    class FormulaEditor {
        constructor(dataSubmitter, isNewGame, lang, nextReviewPromptMinutes) {
            this.dataSubmitter = dataSubmitter;

            hideEverything();

            const nextReviewsDataProvider = nextReviewPromptMinutes ? new NextReviewDataProvider(nextReviewPromptMinutes) : null;

            show(CONTENT.textarea);
            show(HEADER.eye);
            show(HEADER.actionButton);

            HEADER.actionButton.textContent = isNewGame ? lang.startNewGame : lang.applyChange;

            CONTENT.textarea.placeholder = isNewGame ? lang.placeholderNewGame : lang.placeholderChange;

            HEADER.actionButton.addEventListener("click", (e) => {
                e.preventDefault();
                window.localStorage.setItem("formula", CONTENT.textarea.value);
                this.dataSubmitter.submitData(() => {
                    let data = isNewGame ? "start_game" : "formula_updated";
                    if (nextReviewsDataProvider) {
                        data += ";" + nextReviewsDataProvider.calculateNextReviewsData();
                    }
                    return data;
                });
            });
            HEADER.actionButton.setAttribute('disabled', true);

            CONTENT.textarea.addEventListener("input", () => {
                const value = CONTENT.textarea.value;
                if (value.trim()) {
                    HEADER.actionButton.removeAttribute("disabled");
                } else {
                    HEADER.actionButton.setAttribute('disabled', true);
                }
            });

            CONTENT.textarea.value = window.localStorage.getItem("formula") || "";
            if (!CONTENT.textarea.value) {
                let cnt = 0;
                const interval = setInterval(() => {
                    cnt ++;
                    if (cnt < 5) {
                        CONTENT.textarea.classList.toggle('active');
                    }
                    CONTENT.textarea.focus();
                }, 300);
                CONTENT.textarea.addEventListener('click', () => {
                    clearInterval(interval);
                    CONTENT.textarea.classList.remove('active');
                });
            }

            HEADER.eye.addEventListener("click", (e) => {
                e.preventDefault();
                hide(HEADER.eye);
                show(HEADER.pencil);
                hide(CONTENT.textarea);
                show(CONTENT.review);
                CONTENT.review.innerHTML = textToHtml(CONTENT.textarea.value);
            });

            HEADER.pencil.addEventListener("click", (e) => {
                e.preventDefault();
                hide(HEADER.pencil);
                show(HEADER.eye);
                show(CONTENT.textarea);
                hide(CONTENT.review);
            });

            show(FOOTER.parent);
            show(FOOTER.lock);
            show(FOOTER.share);

            FOOTER.lock.addEventListener("click", (e) => {
                hideEverything();
                CONTENT.text.title.innerHTML = lang.formulaSafe;
                CONTENT.text.preFirst.innerHTML = lang.formulaSafeExplained;
                CONTENT.text.link.innerHTML = lang.backToEditor;
                show(CONTENT.text.parent);
                show(CONTENT.text.link);

                function backToEditor(e) {
                    e.preventDefault();
                    hideEverything();

                    show(HEADER.eye);
                    show(HEADER.actionButton);
                    show(CONTENT.textarea);
                    show(FOOTER.parent);
                    show(FOOTER.lock);
                    show(FOOTER.share);

                    CONTENT.text.link.removeEventListener("click", backToEditor);
                }
                CONTENT.text.link.addEventListener("click", backToEditor);

            });

            FOOTER.share.addEventListener("click", (e) => {
                hideEverything();
                CONTENT.text.title.innerHTML = lang.share;
                CONTENT.text.preFirst.innerHTML = lang.shareExplained;
                CONTENT.text.link.innerHTML = lang.backToEditor;
                show(CONTENT.text.parent);
                show(CONTENT.text.link);
                show(CONTENT.text.input);

                const shared_key_uuid = new URLSearchParams(window.location.search).get('shared_key_uuid') || 'undefined';
                CONTENT.text.input.value = shared_key_uuid;

                function backToEditor(e) {
                    e.preventDefault();
                    hideEverything();

                    show(HEADER.eye);
                    show(HEADER.actionButton);
                    show(CONTENT.textarea);
                    show(FOOTER.parent);
                    show(FOOTER.lock);
                    show(FOOTER.share);

                    CONTENT.text.link.removeEventListener("click", backToEditor);
                }
                CONTENT.text.link.addEventListener("click", backToEditor);

            });

            CONTENT.textarea.focus();


        }
    }

    class SetDifficultyComponent {
        constructor(dataSubmitter, lang, newDifficulty, nextReviewPromptMinutes) {
            hideEverything();

            show(CONTENT.text.parent);
            CONTENT.text.title.innerHTML = lang.sureSetDifficulty;
            CONTENT.text.preFirst.innerHTML = lang.sureSetDifficultyDetail;
            show(CONTENT.text.button);
            CONTENT.text.button.textContent = lang.yesSetDifficulty;
            CONTENT.text.button.addEventListener("click", (e) => {
                e.preventDefault();
                window.localStorage.clear();

                dataSubmitter.submitData(() => "set_difficulty:" + newDifficulty + ";" + new NextReviewDataProvider(nextReviewPromptMinutes).calculateNextReviewsData());
            });
        }
    }


    const app = window?.Telegram?.WebApp;

    const urlParams = new URLSearchParams(window.location.search);
    const langCode = urlParams.get('lang_code') || 'en';
    const isNewGame = !!(urlParams.get('new_game'));
    const isReview = !!(urlParams.get('review'));
    const isFormula = !!(urlParams.get('formula'));
    const isDeleteData = !!(urlParams.get('delete_data'));
    const isViewLocalstorageData = !!(urlParams.get('view_localstorage'));
    const newDifficulty = urlParams.get('set_difficulty') || null;


    const nextReviewPromptMinutes = urlParams.get('next_review_prompt_minutes') || null;

    const dataSubmitter = new DataSubmitComponent(app, window.langs[langCode]);

    if (newDifficulty) {
        new SetDifficultyComponent(dataSubmitter, window.langs[langCode], newDifficulty, nextReviewPromptMinutes);
        // dataSubmitter.submitData(() => "set_difficulty:" + newDifficulty + ";" + new NextReviewDataProvider(nextReviewPromptMinutes).calculateNextReviewsData());
    }

    if (isDeleteData) {
        new DeleteDataComponent(dataSubmitter, window.langs[langCode]);
    }

    if (isViewLocalstorageData) {
        new ViewLocalstorageDataComponent();
    }

    class EnterFormulaPrompt {
        constructor(lang) {
            hideEverything();

            show(CONTENT.text.parent);
            CONTENT.text.title.innerHTML = lang.noFormulaTitle;
            CONTENT.text.preFirst.innerHTML = lang.noFormulaExplanation;
        }

    }

    if (isReview) {
        if (window.localStorage.getItem("formula") === null) {
            new EnterFormulaPrompt(window.langs[langCode]);
        } else {
            new ReviewComponent(dataSubmitter, window.langs[langCode], nextReviewPromptMinutes);
        }
    }

    if (isFormula || isNewGame) {
        (new FormulaEditor(dataSubmitter, isNewGame, window.langs[langCode], nextReviewPromptMinutes));
    }

    app?.ready();
    setTimeout(() => {
        app?.expand();
    }, 0);

</script>

</html>